name: Build Executables

on:
    push:
        tags:
            - "v*"
    workflow_dispatch:

jobs:
    build:
        strategy:
            matrix:
                include:
                    - os: ubuntu-latest
                      target: bun-linux-x64
                      artifact: node-cache-builder-linux
                    - os: macos-latest
                      target: bun-darwin-x64
                      artifact: node-cache-builder-macos-x64
                    - os: macos-latest
                      target: bun-darwin-arm64
                      artifact: node-cache-builder-macos-arm64
                    - os: windows-latest
                      target: bun-windows-x64
                      artifact: node-cache-builder.exe

        runs-on: ${{ matrix.os }}

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: latest

            - name: Install dependencies
              run: bun install

            - name: Build executable
              run: bun build ./src/cli.ts --compile --target=${{ matrix.target }} --outfile ./bin/${{ matrix.artifact }}

            - name: Upload artifact
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ matrix.artifact }}
                  path: ./bin/${{ matrix.artifact }}
                  retention-days: 30

    release:
        needs: build
        runs-on: ubuntu-latest
        if: startsWith(github.ref, 'refs/tags/')

        steps:
            - name: Download all artifacts
              uses: actions/download-artifact@v4
              with:
                  path: ./artifacts

            - name: Create Release
              uses: softprops/action-gh-release@v1
              with:
                  files: ./artifacts/**/*
                  generate_release_notes: true
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
